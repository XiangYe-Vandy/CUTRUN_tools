
# go to peak dir
cd /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/
# prepare merged peaks from all samples for H3K27ac
cat 7523-MM-01.idr.01.bed 7523-MM-06.idr.01.bed 7523-MM-11.idr.01.bed 7523-MM-16.idr.01.bed 7523-MM-21.idr.01.bed 7523-MM-26.idr.01.bed 7523-MM-31.idr.01.bed 7523-MM-36.idr.01.bed 7523-MM-41.idr.01.bed 7523-MM-46.idr.01.bed 7523-MM-51.idr.01.bed 7523-MM-56.idr.01.bed 7523-MM-61.idr.01.bed > all_H3K27ac_peaks.bed
bedtools sort -i all_H3K27ac_peaks.bed > all_H3K27ac_peaks.srt.bed
bedtools merge -i all_H3K27ac_peaks.srt.bed > all_H3K27ac_peaks.merged.bed

# prepare merged peaks from all samples for H3K27ac
cat 7523-MM-03.idr.01.bed 7523-MM-08.idr.01.bed 7523-MM-13.idr.01.bed 7523-MM-18.idr.01.bed 7523-MM-23.idr.01.bed 7523-MM-28.idr.01.bed 7523-MM-33.idr.01.bed 7523-MM-38.idr.01.bed 7523-MM-43.idr.01.bed 7523-MM-48.idr.01.bed 7523-MM-53.idr.01.bed 7523-MM-58.idr.01.bed 7523-MM-63.idr.01.bed > all_H3K27me3_peaks.bed
bedtools sort -i all_H3K27me3_peaks.bed > all_H3K27me3_peaks.srt.bed
bedtools merge -i all_H3K27me3_peaks.srt.bed > all_H3K27me3_peaks.merged.bed

# go to work dir
cd /home/xiang/DNA_seq/CD8_CUTRUN
# multiBigwigSummary BED-file -b all_ChIPseq_aligned/7524-MM-01.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-02.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-06.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-07.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-11.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-12.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-16.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-17.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-21.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-22.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-26.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-27.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-31.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-32.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-36.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-37.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-41.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-42.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-46.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-47.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-51.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-52.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-56.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-57.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-61.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-62.filteredChr.bam.bw -o all_peaks_multibw_7523ac.npz --BED /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27ac_peaks.merged.bed -p 32 --labels 0hr_A 0hr_B 4hr_CTL_A 4hr_CTL_B 4hr_CB839_A 4hr_CB839_B 4hr_DON_A 4hr_DON_B 4hr_NoQ_A 4hr_NoQ_B 24hr_CTL_A 24hr_CTL_B 24hr_CB839_A 24hr_CB839_B 24hr_DON_A 24hr_DON_B 24hr_NoQ_A 24hr_NoQ_B 48hr_CTL_A 48hr_CTL_B 48hr_CB839_A 48hr_CB839_B 48hr_DON_A 48hr_DON_B 48hr_NoQ_A 48hr_NoQ_B



# multiBigwigSummary bins -b all_ChIPseq_aligned/7523-MM-01.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-02.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-06.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-07.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-11.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-12.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-16.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-17.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-21.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-22.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-26.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-27.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-31.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-32.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-36.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-37.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-41.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-42.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-46.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-47.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-51.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-52.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-56.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-57.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-61.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-62.filteredChr.bam.bw -o all_peaks_multibw_bin500.npz -bs 500 -p 24 --labels 0hr_A 0hr_B 4hr_CTL_A 4hr_CTL_B 4hr_CB839_A 4hr_CB839_B 4hr_DON_A 4hr_DON_B 4hr_NoQ_A 4hr_NoQ_B 24hr_CTL_A 24hr_CTL_B 24hr_CB839_A 24hr_CB839_B 24hr_DON_A 24hr_DON_B 24hr_NoQ_A 24hr_NoQ_B 48hr_CTL_A 48hr_CTL_B 48hr_CB839_A 48hr_CB839_B 48hr_DON_A 48hr_DON_B 48hr_NoQ_A 48hr_NoQ_B -bl /home/xiang/DNA_seq/CD8_CUTRUN/mm10.blacklist.bed --outRawCounts all_K27ac_rawCounts_multibw.tab




# multiBigwigSummary BED-file -b all_ChIPseq_aligned/7523-MM-03.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-04.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-08.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-09.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-13.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-14.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-18.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-19.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-23.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-24.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-28.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-29.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-33.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-34.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-38.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-39.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-43.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-44.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-48.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-49.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-53.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-54.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-58.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-59.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-63.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-64.filteredChr.bam.bw -o all_peaks_multibw_7523me.npz --BED /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27me3_peaks.merged.bed -p 32 --labels 0hr_A 0hr_B 4hr_CTL_A 4hr_CTL_B 4hr_CB839_A 4hr_CB839_B 4hr_DON_A 4hr_DON_B 4hr_NoQ_A 4hr_NoQ_B 24hr_CTL_A 24hr_CTL_B 24hr_CB839_A 24hr_CB839_B 24hr_DON_A 24hr_DON_B 24hr_NoQ_A 24hr_NoQ_B 48hr_CTL_A 48hr_CTL_B 48hr_CB839_A 48hr_CB839_B 48hr_DON_A 48hr_DON_B 48hr_NoQ_A 48hr_NoQ_B
# multiBigwigSummary bins -bs 500 -b all_ChIPseq_aligned/7523-MM-03.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-04.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-08.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-09.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-13.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-14.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-18.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-19.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-23.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-24.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-28.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-29.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-33.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-34.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-38.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-39.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-43.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-44.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-48.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-49.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-53.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-54.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-58.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-59.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-63.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-64.filteredChr.bam.bw -o all_peaks_multibw_7523me.npz -p 24 --labels 0hr_A 0hr_B 4hr_CTL_A 4hr_CTL_B 4hr_CB839_A 4hr_CB839_B 4hr_DON_A 4hr_DON_B 4hr_NoQ_A 4hr_NoQ_B 24hr_CTL_A 24hr_CTL_B 24hr_CB839_A 24hr_CB839_B 24hr_DON_A 24hr_DON_B 24hr_NoQ_A 24hr_NoQ_B 48hr_CTL_A 48hr_CTL_B 48hr_CB839_A 48hr_CB839_B 48hr_DON_A 48hr_DON_B 48hr_NoQ_A 48hr_NoQ_B -bl /home/xiang/DNA_seq/CD8_CUTRUN/mm10.blacklist.bed --outRawCounts all_K27me3_rawCounts_multibw.tab



#plotPCA --corData all_peaks_multibw_7523ac.npz -o all_peaks_multibw_7523ac.pdf --transpose --ntop 8000
#plotPCA --corData all_peaks_multibw_7523ac.npz -o all_peaks_multibw_7523ac_PC1_3.pdf --PCs 1 3 --transpose --ntop 8000
#plotPCA --corData all_peaks_multibw_7523ac.npz -o all_peaks_multibw_7523ac_PC2_3.pdf --PCs 2 3 --transpose --ntop 8000


#plotPCA --corData all_peaks_multibw_7523me.npz -o all_peaks_multibw_7523me.pdf --transpose --ntop 4000
#plotPCA --corData all_peaks_multibw_7523me.npz -o all_peaks_multibw_7523me_PC1_3.pdf --PCs 1 3 --transpose --ntop 4000
#plotPCA --corData all_peaks_multibw_7523me.npz -o all_peaks_multibw_7523me_PC2_3.pdf --PCs 2 3 --transpose --ntop 4000



#computeMatrix reference-point --referencePoint center -S all_ChIPseq_aligned/7523-MM-01.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-02.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-06.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-07.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-11.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-12.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-16.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-17.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-21.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-22.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-26.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-27.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-31.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-32.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-36.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-37.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-41.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-42.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-46.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-47.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-51.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-52.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-56.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-57.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-61.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-62.filteredChr.bam.bw -o all_peaks_mx_7523ac.npz -R /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27ac_peaks.merged.bed -a 3000 -b 3000 -p 32

# 0h + 4hr
#computeMatrix reference-point --referencePoint center -S all_ChIPseq_aligned/7523-MM-01.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-02.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-06.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-07.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-11.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-12.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-16.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-17.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-21.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-22.filteredChr.bam.bw -o all_peaks_mx_7523ac_0hr_4hr.npz -R /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27ac_peaks.merged.bed -a 3000 -b 3000 -p 32

# 24hr
#computeMatrix reference-point --referencePoint center -S all_ChIPseq_aligned/7523-MM-26.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-27.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-31.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-32.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-36.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-37.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-41.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-42.filteredChr.bam.bw -o all_peaks_mx_7523ac_24hr.npz -R /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27ac_peaks.merged.bed -a 3000 -b 3000 -p 32

# 48hr
#computeMatrix reference-point --referencePoint center -S all_ChIPseq_aligned/7523-MM-46.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-47.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-51.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-52.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-56.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-57.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-61.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-62.filteredChr.bam.bw -o all_peaks_mx_7523ac_48h.npz -R /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27ac_peaks.merged.bed -a 3000 -b 3000 -p 32

#plotHeatmap -m all_peaks_mx_7523ac.npz -o all_peaks_mx_7523ac.pdf --samplesLabel 0hrA 0hrB 4hrA 4hrB 4hr_CB839A 4hr_CB839B 4hr_DONA 4hr_DONB 4hr_NoQA 4hr_NoQB 24hrA 24hrB 24hr_CB839A 24hr_CB839B 24hr_DONA 24hr_DONB 24hr_NoQA 24hr_NoQB 48hrA 48hrB 48hr_CB839A 48hr_CB839B 48hr_DONA 48hr_DONB 48hr_NoQA 48hr_NoQB

#plotProfile -m all_peaks_mx_7523ac.npz -o all_peaks_mx_7523ac_line.pdf --samplesLabel 0hrA 0hrB 4hrA 4hrB 4hr_CB839A 4hr_CB839B 4hr_DONA 4hr_DONB 4hr_NoQA 4hr_NoQB 24hrA 24hrB 24hr_CB839A 24hr_CB839B 24hr_DONA 24hr_DONB 24hr_NoQA 24hr_NoQB 48hrA 48hrB 48hr_CB839A 48hr_CB839B 48hr_DONA 48hr_DONB 48hr_NoQA 48hr_NoQB


# computeMatrix reference-point --referencePoint center -S all_ChIPseq_aligned/7523-MM-03.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-04.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-08.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-09.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-13.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-14.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-18.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-19.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-23.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-24.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-28.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-29.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-33.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-34.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-38.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-39.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-43.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-44.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-48.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-49.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-53.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-54.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-58.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-59.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-63.filteredChr.bam.bw all_ChIPseq_aligned/7523-MM-64.filteredChr.bam.bw -o all_peaks_mx_7523me.npz -R /home/xiang/DNA_seq/CD8_CUTRUN/all_macs2_out/all_H3K27me3_peaks.merged.bed -a 3000 -b 3000 -p 32


plotHeatmap -m all_peaks_mx_7523me.npz -o all_peaks_mx_7523me.pdf --samplesLabel 0hrA 0hrB 4hrA 4hrB 4hr_CB839A 4hr_CB839B 4hr_DONA 4hr_DONB 4hr_NoQA 4hr_NoQB 24hrA 24hrB 24hr_CB839A 24hr_CB839B 24hr_DONA 24hr_DONB 24hr_NoQA 24hr_NoQB 48hrA 48hrB 48hr_CB839A 48hr_CB839B 48hr_DONA 48hr_DONB 48hr_NoQA 48hr_NoQB

plotProfile -m all_peaks_mx_7523me.npz -o all_peaks_mx_7523me_line.pdf --samplesLabel 0hrA 0hrB 4hrA 4hrB 4hr_CB839A 4hr_CB839B 4hr_DONA 4hr_DONB 4hr_NoQA 4hr_NoQB 24hrA 24hrB 24hr_CB839A 24hr_CB839B 24hr_DONA 24hr_DONB 24hr_NoQA 24hr_NoQB 48hrA 48hrB 48hr_CB839A 48hr_CB839B 48hr_DONA 48hr_DONB 48hr_NoQA 48hr_NoQB
